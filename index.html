<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>QR-Code Scanner mit Zoom</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #reader { width: 300px; margin: auto; }
    canvas, img { display: none; margin-top: 10px; border: 1px solid #000; }
  </style>
</head>
<body>

  <h1>QR-Code Scanner mit Bildaufnahme</h1>
  <div id="reader"></div>
  <button id="captureBtn">ğŸ“¸ Bild aufnehmen & analysieren</button>
  <canvas id="snapshotCanvas"></canvas>
  <img id="snapshotImg" />
  <div id="result">Warte auf Aufnahmeâ€¦</div>

  <script>
    const html5QrCode = new Html5Qrcode("reader");
    const snapshotCanvas = document.getElementById("snapshotCanvas");
    const snapshotImg = document.getElementById("snapshotImg");
    const resultDiv = document.getElementById("result");

    let videoTrack;

    // Kamera starten
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (text) => {
        resultDiv.innerText = "Live-Scan: " + text;
      }
    ).then((stream) => {
      videoTrack = stream.getVideoTracks()[0]; // Zugriff auf das Kamera-Video fÃ¼r spÃ¤ter
    }).catch((err) => {
      resultDiv.innerText = "Kamera konnte nicht gestartet werden: " + err;
    });

    document.getElementById("captureBtn").addEventListener("click", async () => {
      const video = document.querySelector("video");
      if (!video) {
        alert("Kein Video verfÃ¼gbar");
        return;
      }

      // AuflÃ¶sung bestimmen
      const width = video.videoWidth;
      const height = video.videoHeight;

      // Canvas vorbereiten
      snapshotCanvas.width = width;
      snapshotCanvas.height = height;
      const ctx = snapshotCanvas.getContext("2d");
      ctx.drawImage(video, 0, 0, width, height);

      // Zoom-Bereich (zentraler Ausschnitt)
      const zoomFactor = 2.0;
      const zoomWidth = width / zoomFactor;
      const zoomHeight = height / zoomFactor;
      const zoomX = (width - zoomWidth) / 2;
      const zoomY = (height - zoomHeight) / 2;

      // Neuer Canvas fÃ¼r Zoom
      const zoomCanvas = document.createElement("canvas");
      zoomCanvas.width = zoomWidth;
      zoomCanvas.height = zoomHeight;
      const zoomCtx = zoomCanvas.getContext("2d");
      zoomCtx.drawImage(snapshotCanvas, zoomX, zoomY, zoomWidth, zoomHeight, 0, 0, zoomWidth, zoomHeight);

      // DataURL erzeugen & anzeigen (optional)
      const dataUrl = zoomCanvas.toDataURL("image/png");
      snapshotImg.src = dataUrl;
      snapshotImg.style.display = "block";

      // Jetzt mit html5-qrcode das Bild scannen
      const tempQrScanner = new Html5Qrcode("temp-scan"); // Dummy-ID
      tempQrScanner.scanFile(dataUrl, true)
        .then(qrCodeMessage => {
          resultDiv.innerText = "ğŸ“¦ Gescannter Inhalt (Foto): " + qrCodeMessage;
        })
        .catch(err => {
          resultDiv.innerText = "âŒ Kein QR-Code erkannt: " + err;
        });
    });
  </script>

</body>
</html>
