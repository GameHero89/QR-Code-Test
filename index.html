<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>QR-Code Scanner mit Zoom</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
    }
    #qr-reader {
      width: 300px;
      margin: auto;
    }
    #zoomSlider {
      width: 80%;
      margin-top: 1rem;
      display: none;
    }
    #qr-result {
      margin-top: 1rem;
      font-weight: bold;
    }
    #cameraList {
      margin: 1rem auto;
      max-width: 90%;
    }
  </style>
</head>
<body>

  <h1>Live QR-Code Scanner mit Zoom</h1>
  <select id="cameraList" style="display:none;"></select>
  <div id="qr-reader"></div>
  <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1" />
  <div id="qr-result">Bitte Kamera aktivieren…</div>

  <script>
    const qrResult = document.getElementById("qr-result");
    const zoomSlider = document.getElementById("zoomSlider");
    const cameraList = document.getElementById("cameraList");

    const qrCodeScanner = new Html5Qrcode("qr-reader");

    async function initCameraScanner() {
      try {
        // Zuerst Kamera-Rechte anfordern, damit wir `label` bekommen
        await navigator.mediaDevices.getUserMedia({ video: true });

        const cameras = await Html5Qrcode.getCameras();
        console.log("Gefundene Kameras:", cameras);

        if (cameras.length === 0) {
          qrResult.innerText = "❌ Keine Kamera gefunden.";
          return;
        }

        // Kamera-Auswahlliste anzeigen
        cameraList.style.display = "block";
        cameraList.innerHTML = "";

        cameras.forEach((cam, index) => {
          const option = document.createElement("option");
          option.value = cam.id;
          option.textContent = cam.label || `Kamera ${index + 1}`;
          cameraList.appendChild(option);
        });

        // Standard: Rückkamera oder erste
        const defaultCamera = cameras.find(c => c.label.toLowerCase().includes("back")) || cameras[0];
        cameraList.value = defaultCamera.id;

        // Starten
        startScanner(defaultCamera.id);

        // Wechsel bei Auswahl
        cameraList.addEventListener("change", () => {
          qrCodeScanner.stop().then(() => {
            startScanner(cameraList.value);
          });
        });

      } catch (err) {
        qrResult.innerText = "❌ Fehler beim Kamera-Zugriff: " + err;
        console.error(err);
      }
    }

    function startScanner(cameraId) {
      qrCodeScanner.start(
        cameraId,
        {
          fps: 10,
          qrbox: 250,
          aspectRatio: 1.33
        },
        qrCodeMessage => {
          qrResult.innerText = "✅ QR-Code erkannt: " + qrCodeMessage;
        },
        errorMessage => {
          qrResult.innerText = "Scanne…";
        }
      ).then(() => {
        const track = qrCodeScanner.getRunningTrack();
        const capabilities = track?.getCapabilities();

        if (capabilities?.zoom) {
          zoomSlider.style.display = "block";
          zoomSlider.min = capabilities.zoom.min;
          zoomSlider.max = capabilities.zoom.max;
          zoomSlider.step = capabilities.zoom.step || 0.1;
          zoomSlider.value = capabilities.zoom.min;

          zoomSlider.oninput = () => {
            track.applyConstraints({ advanced: [{ zoom: parseFloat(zoomSlider.value) }] });
          };
        } else {
          zoomSlider.style.display = "none";
          console.warn("Zoom wird nicht unterstützt.");
        }
      }).catch(err => {
        qrResult.innerText = "❌ Fehler beim Starten des Scanners: " + err;
      });
    }

    // Start
    initCameraScanner();
  </script>

</body>
</html>
